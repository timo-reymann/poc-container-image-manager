# Package Locking for Reproducible Builds

## Overview

Add a `lock` command that resolves package versions from distro APIs and stores them in a lock file. The `generate` command then auto-rewrites install commands to pin versions.

## Commands

```bash
image-manager lock base:2025.09      # Generate/update packages.lock
image-manager lock --update          # Update all lock files
image-manager generate base:2025.09  # Uses lock file to pin versions
```

## Lock File

**Location:** `images/<name>/<version>/packages.lock`

```yaml
# Generated by: image-manager lock base:2025.09
# Source: packages.ubuntu.com
# Base: ubuntu:24.04
# Codename: noble
# Date: 2026-01-04T15:30:00Z
packages:
  curl: "8.5.0-2ubuntu10.6"
  git: "1:2.43.0-1ubuntu7.2"
  wget: "1.21.4-1ubuntu4.1"
```

## Lock Flow

1. Parse generated Dockerfile (not template) → find `FROM` line
2. Resolve base image chain to find root distro (e.g., `ubuntu:24.04`)
3. Query Launchpad series API → `24.04` → `noble` (no hardcoded mappings)
4. Parse `apt-get install` commands → extract package names
5. Query packages.ubuntu.com for each package + codename
6. Write `packages.lock`

## Generate Flow

1. Read `Dockerfile.jinja2`: `apt-get install -y curl git wget`
2. Load `packages.lock`
3. Rewrite to: `apt-get install -y curl=8.5.0-2ubuntu10.6 git=1:2.43.0-1ubuntu7.2 wget=1.21.4-1ubuntu4.1`
4. Write `dist/.../Dockerfile`

## Base Image Resolution

**For root images** (e.g., `base:2025.09`):
- Parse `FROM ubuntu:24.04` → query Ubuntu API

**For derived images** (e.g., `python:3.13.7`):
- Parse `FROM {{ "base" | resolve_base_image }}`
- Resolve to `base:2025.09`
- Look up base's distro → `ubuntu:noble`
- Use same codename for package queries

## Distro Support

Ubuntu only (for now). Uses:
- `https://api.launchpad.net/1.0/ubuntu/series` - version → codename
- `https://packages.ubuntu.com/{codename}/{package}` - package versions

## Error Handling

- **No lock file + generate** → Warning: "No packages.lock found, versions unpinned"
- **Package not in lock file** → Error: "Package 'foo' not in packages.lock, run `image-manager lock`"
- **API unreachable** → Error with cached fallback if lock exists
