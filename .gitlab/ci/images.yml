# Auto-generated by image-manager generate-ci
# Generated: 2026-01-30T16:47:55.952874+00:00
# Do not edit - regenerate with: image-manager generate-ci

stages:
  - generate
  - build-base
  - manifest-base
  - build-dotnet
  - manifest-dotnet
  - build-python
  - manifest-python
  - test

variables:
  SNAPSHOT_ID: ${CI_MERGE_REQUEST_IID}

# === BASE TEMPLATES ===

.build:
  image: registry.example.com/ci/image-manager:latest
  services:
    - name: moby/buildkit:latest
      alias: buildkitd
      command: ["--addr", "tcp://0.0.0.0:8372"]
  variables:
    BUILDKIT_HOST: tcp://buildkitd:8372
  script:
    - image-manager build ${IMAGE_NAME} --platform ${PLATFORM} --snapshot-id "$SNAPSHOT_ID"
    - image-manager sbom ${IMAGE_NAME} --platform ${PLATFORM} --snapshot-id "$SNAPSHOT_ID"

.manifest:
  image: registry.example.com/ci/image-manager:latest
  script:
    - image-manager manifest ${IMAGE_NAME} --snapshot-id "$SNAPSHOT_ID"
    - image-manager retag ${IMAGE_NAME} --snapshot-id "$SNAPSHOT_ID"

.test:
  image: registry.example.com/ci/image-manager:latest
  stage: test
  services:
    - name: docker:dind
      alias: dind
  variables:
    DOCKER_HOST: tcp://dind:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - image-manager test ${IMAGE_NAME} --snapshot-id "$SNAPSHOT_ID" --pull

# === GENERATE ===
generate:
  image: registry.example.com/ci/image-manager:latest
  stage: generate
  script:
    - image-manager generate --snapshot-id "$SNAPSHOT_ID"
  artifacts:
    paths:
      - dist/
    expire_in: 1 week


# === BASE ===

build-base-amd64:
  extends: .build
  stage: build-base
  variables:
    IMAGE_NAME: base
    PLATFORM: amd64
  needs:
    - generate

build-base-arm64:
  extends: .build
  stage: build-base
  variables:
    IMAGE_NAME: base
    PLATFORM: arm64
  needs:
    - generate

manifest-base:
  extends: .manifest
  stage: manifest-base
  variables:
    IMAGE_NAME: base
  needs:
    - generate
    - build-base-amd64
    - build-base-arm64

test-base:
  extends: .test
  variables:
    IMAGE_NAME: base
  needs:
    - generate
    - manifest-base


# === DOTNET ===

build-dotnet-amd64:
  extends: .build
  stage: build-dotnet
  variables:
    IMAGE_NAME: dotnet
    PLATFORM: amd64
  needs:
    - generate
    - test-base

build-dotnet-arm64:
  extends: .build
  stage: build-dotnet
  variables:
    IMAGE_NAME: dotnet
    PLATFORM: arm64
  needs:
    - generate
    - test-base

manifest-dotnet:
  extends: .manifest
  stage: manifest-dotnet
  variables:
    IMAGE_NAME: dotnet
  needs:
    - generate
    - build-dotnet-amd64
    - build-dotnet-arm64

test-dotnet:
  extends: .test
  variables:
    IMAGE_NAME: dotnet
  needs:
    - generate
    - manifest-dotnet


# === PYTHON ===

build-python-amd64:
  extends: .build
  stage: build-python
  variables:
    IMAGE_NAME: python
    PLATFORM: amd64
  needs:
    - generate
    - test-base

build-python-arm64:
  extends: .build
  stage: build-python
  variables:
    IMAGE_NAME: python
    PLATFORM: arm64
  needs:
    - generate
    - test-base

manifest-python:
  extends: .manifest
  stage: manifest-python
  variables:
    IMAGE_NAME: python
  needs:
    - generate
    - build-python-amd64
    - build-python-arm64

test-python:
  extends: .test
  variables:
    IMAGE_NAME: python
  needs:
    - generate
    - manifest-python

