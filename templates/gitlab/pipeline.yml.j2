# Auto-generated by image-manager generate-ci
# Generated: {{ generated_at }}
# Do not edit - regenerate with: image-manager generate-ci

stages:
  - generate
{%- for stage in stages %}
  - {{ stage }}
{%- endfor %}

variables:
  SNAPSHOT_ID: ${CI_MERGE_REQUEST_IID}

# === BASE TEMPLATES ===

.build:
  image: {{ ci_image | default('registry.example.com/ci/image-manager:latest') }}
  services:
    - name: moby/buildkit:latest
      alias: buildkitd
      command: ["--addr", "tcp://0.0.0.0:8372"]
  variables:
    BUILDKIT_HOST: tcp://buildkitd:8372
  script:
    - image-manager build ${IMAGE_NAME} --platform ${PLATFORM} --snapshot-id "$SNAPSHOT_ID"
    - image-manager sbom ${IMAGE_NAME} --platform ${PLATFORM} --snapshot-id "$SNAPSHOT_ID"
{%- if artifacts %}
  artifacts:
    paths:
      - dist/${IMAGE_NAME}/*/linux-${PLATFORM}/
    expire_in: 1 week
{%- endif %}

.manifest:
  image: {{ ci_image | default('registry.example.com/ci/image-manager:latest') }}
  script:
    - image-manager manifest ${IMAGE_NAME} --snapshot-id "$SNAPSHOT_ID"
    - image-manager retag ${IMAGE_NAME} --snapshot-id "$SNAPSHOT_ID"
{%- if artifacts %}
  artifacts:
    paths:
      - dist/${IMAGE_NAME}/*/image.tar
      - dist/${IMAGE_NAME}/*/index.html
    expire_in: 1 week
{%- endif %}

.test:
  image: {{ ci_image | default('registry.example.com/ci/image-manager:latest') }}
  stage: test
  services:
    - name: docker:dind
      alias: dind
  variables:
    DOCKER_HOST: tcp://dind:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - image-manager test ${IMAGE_NAME} --snapshot-id "$SNAPSHOT_ID"{% if not artifacts %} --pull{% endif %}

# === GENERATE ===
generate:
  image: {{ ci_image | default('registry.example.com/ci/image-manager:latest') }}
  stage: generate
  script:
    - image-manager generate --snapshot-id "$SNAPSHOT_ID"
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
{% for image in images %}

# === {{ image.name | upper }} ===
{% include 'build-job.yml.j2' -%}
{% include 'manifest-job.yml.j2' -%}
{% include 'test-job.yml.j2' -%}
{% endfor %}
