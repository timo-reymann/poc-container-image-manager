# Auto-generated by image-manager generate-ci
# Generated: {{ generated_at }}
# Custom template for GHCR publishing with gh-pages reports
# Regenerate with: image-manager generate-ci --template .github/ci-templates/ --output .github/workflows/images.yml

name: Build Images

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  SNAPSHOT_ID: {{ "${{ github.event.pull_request.number }}" }}
  REGISTRY_URL: ghcr.io/{{ "${{ github.repository }}" }}
  REGISTRY_USERNAME: {{ "${{ github.actor }}" }}
  REGISTRY_PASSWORD: {{ "${{ secrets.GITHUB_TOKEN }}" }}

permissions:
  actions: write
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  # === GENERATE ===
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Generate Dockerfiles and configs
        run: uv run image-manager generate --snapshot-id "$SNAPSHOT_ID"

      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated
          path: dist/
          retention-days: 7

{% for image in images %}
  # === {{ image.name | upper }} ===
  # Build amd64
  build-{{ image.name }}-amd64:
    runs-on: ubuntu-latest
    needs:
      - generate
{%- if image.dependencies %}
{%- for dep in image.dependencies %}
      - test-{{ dep }}
{%- endfor %}
{%- endif %}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: {{ "${{ github.actor }}" }}
          password: {{ "${{ secrets.GITHUB_TOKEN }}" }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Expose GitHub Runtime
        uses: crazy-max/ghaction-github-runtime@v3

      - name: Build {{ image.name }} for amd64
        run: uv run image-manager build {{ image.name }} --snapshot-id "$SNAPSHOT_ID" --platform amd64

      - name: Generate SBOM for {{ image.name }} (amd64)
        run: uv run image-manager sbom {{ image.name }} --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: {{ image.name }}-amd64-build
          path: |
            dist/{{ image.name }}/*/linux-amd64/sbom*.json
            dist/{{ image.name }}/*/linux-amd64/sbom-report.html
            dist/{{ image.name }}/*/index.html
            dist/{{ image.name }}/*/*.html
            dist/{{ image.name }}/*/*.json
          retention-days: 7

  # Build arm64
  build-{{ image.name }}-arm64:
    runs-on: ubuntu-24.04-arm
    needs:
      - generate
{%- if image.dependencies %}
{%- for dep in image.dependencies %}
      - test-{{ dep }}
{%- endfor %}
{%- endif %}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: {{ "${{ github.actor }}" }}
          password: {{ "${{ secrets.GITHUB_TOKEN }}" }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Expose GitHub Runtime
        uses: crazy-max/ghaction-github-runtime@v3

      - name: Build {{ image.name }} for arm64
        run: uv run image-manager build {{ image.name }} --snapshot-id "$SNAPSHOT_ID" --platform arm64

      - name: Generate SBOM for {{ image.name }} (arm64)
        run: uv run image-manager sbom {{ image.name }} --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: {{ image.name }}-arm64-build
          path: |
            dist/{{ image.name }}/*/linux-arm64/sbom*.json
            dist/{{ image.name }}/*/linux-arm64/sbom-report.html
            dist/{{ image.name }}/*/index.html
            dist/{{ image.name }}/*/*.html
            dist/{{ image.name }}/*/*.json
          retention-days: 7

  # Create multi-platform manifest
  manifest-{{ image.name }}:
    runs-on: ubuntu-latest
    needs:
      - build-{{ image.name }}-amd64
      - build-{{ image.name }}-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: {{ "${{ github.actor }}" }}
          password: {{ "${{ secrets.GITHUB_TOKEN }}" }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Create multi-platform manifest for {{ image.name }}
        run: uv run image-manager manifest {{ image.name }} --snapshot-id "$SNAPSHOT_ID"

      - name: Apply aliases for {{ image.name }}
        run: uv run image-manager retag {{ image.name }} --snapshot-id "$SNAPSHOT_ID"

  test-{{ image.name }}:
    runs-on: ubuntu-latest
    needs:
      - manifest-{{ image.name }}
    services:
      dind:
        image: docker:dind
        ports:
          - 2375:2375
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: ""
    env:
      DOCKER_HOST: tcp://127.0.0.1:2375
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Wait for Docker
        run: |
          for i in {1..30}; do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              exit 0
            fi
            echo "Waiting for Docker... ($i/30)"
            sleep 1
          done
          echo "Docker failed to start"
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        run: echo "$REGISTRY_PASSWORD" | docker login ghcr.io -u "$REGISTRY_USERNAME" --password-stdin

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Test {{ image.name }}
        run: uv run image-manager test {{ image.name }} --snapshot-id "$SNAPSHOT_ID" --pull

{% endfor %}
  # === DEPLOY REPORTS TO GH-PAGES ===
  deploy-reports:
    runs-on: ubuntu-latest
    needs:
{%- for image in images %}
      - test-{{ image.name }}
{%- endfor %}
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync
{%- for image in images %}

      - name: Download {{ image.name }}-amd64-build artifact
        uses: actions/download-artifact@v4
        with:
          name: {{ image.name }}-amd64-build
          path: dist/

      - name: Download {{ image.name }}-arm64-build artifact
        uses: actions/download-artifact@v4
        with:
          name: {{ image.name }}-arm64-build
          path: dist/
{%- endfor %}

      - name: Generate overview report
        run: uv run image-manager generate

      - name: Prepare gh-pages content
        run: |
          mkdir -p gh-pages-content
          # Copy all HTML reports
          find dist -name "*.html" -exec cp --parents {} gh-pages-content/ \;
          # Copy all SBOM JSON files
          find dist -name "sbom*.json" -exec cp --parents {} gh-pages-content/ \;
          # Move dist contents to root of gh-pages
          mv gh-pages-content/dist/* gh-pages-content/ || true
          rm -rf gh-pages-content/dist

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: {{ "${{ secrets.GITHUB_TOKEN }}" }}
          publish_dir: ./gh-pages-content
          publish_branch: gh-pages
          force_orphan: true
