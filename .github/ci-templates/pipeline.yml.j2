# Auto-generated by image-manager generate-ci
# Generated: {{ generated_at }}
# Custom template for GHCR publishing with gh-pages reports
# Regenerate with: image-manager generate-ci --template .github/ci-templates/ --output .github/workflows/images.yml

name: Build Images

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  SNAPSHOT_ID: {{ "${{ github.event.pull_request.number }}" }}
  REGISTRY_URL: ghcr.io/{{ "${{ github.repository }}" }}
  REGISTRY_USERNAME: {{ "${{ github.actor }}" }}
  REGISTRY_PASSWORD: {{ "${{ secrets.GITHUB_TOKEN }}" }}

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  # === GENERATE ===
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Generate Dockerfiles and configs
        run: uv run image-manager generate --snapshot-id "$SNAPSHOT_ID"

      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated
          path: dist/
          retention-days: 7

{% for image in images %}
  # === {{ image.name | upper }} ===
{% for platform in platforms %}
  build-{{ image.name }}-{{ platform }}:
    runs-on: {{ 'ubuntu-24.04-arm' if platform == 'arm64' else 'ubuntu-latest' }}
    needs:
      - generate
{%- if image.dependencies %}
{%- for dep in image.dependencies %}
      - manifest-{{ dep }}
{%- endfor %}
{%- endif %}
    env:
      BUILDKIT_HOST: tcp://127.0.0.1:8372
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Start buildkitd
        run: |
          docker run -d --name buildkitd --privileged \
            -p 127.0.0.1:8372:8372 \
            moby/buildkit:latest \
            --addr tcp://0.0.0.0:8372
          # Wait for buildkitd to be ready
          for i in {1..30}; do
            if nc -z 127.0.0.1 8372 2>/dev/null; then
              echo "buildkitd is ready"
              exit 0
            fi
            echo "Waiting for buildkitd... ($i/30)"
            sleep 1
          done
          echo "buildkitd logs:"
          docker logs buildkitd
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: {{ "${{ github.actor }}" }}
          password: {{ "${{ secrets.GITHUB_TOKEN }}" }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Build {{ image.name }} ({{ platform }})
        run: uv run image-manager build {{ image.name }} --platform {{ platform }} --snapshot-id "$SNAPSHOT_ID"

      - name: Generate SBOM for {{ image.name }} ({{ platform }})
        run: uv run image-manager sbom {{ image.name }} --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: {{ image.name }}-{{ platform }}
          path: |
            dist/{{ image.name }}/*/linux-{{ platform }}/sbom*.json
            dist/{{ image.name }}/*/linux-{{ platform }}/sbom-report.html
          retention-days: 7
{% endfor %}

  manifest-{{ image.name }}:
    runs-on: ubuntu-latest
    needs:
{%- for platform in platforms %}
      - build-{{ image.name }}-{{ platform }}
{%- endfor %}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: {{ "${{ github.actor }}" }}
          password: {{ "${{ secrets.GITHUB_TOKEN }}" }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync
{%- for platform in platforms %}

      - name: Download {{ image.name }}-{{ platform }} artifact
        uses: actions/download-artifact@v4
        with:
          name: {{ image.name }}-{{ platform }}
          path: dist/
{%- endfor %}

      - name: Create manifest for {{ image.name }}
        run: uv run image-manager manifest {{ image.name }} --snapshot-id "$SNAPSHOT_ID"

      - name: Upload manifest artifacts
        uses: actions/upload-artifact@v4
        with:
          name: {{ image.name }}-manifest
          path: |
            dist/{{ image.name }}/*/index.html
            dist/{{ image.name }}/*/*.html
            dist/{{ image.name }}/*/*.json
          retention-days: 7

  test-{{ image.name }}:
    runs-on: ubuntu-latest
    needs:
      - manifest-{{ image.name }}
    services:
      dind:
        image: docker:dind
        ports:
          - 2375:2375
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: ""
    env:
      DOCKER_HOST: tcp://127.0.0.1:2375
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Wait for Docker
        run: |
          for i in {1..30}; do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              exit 0
            fi
            echo "Waiting for Docker... ($i/30)"
            sleep 1
          done
          echo "Docker failed to start"
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        run: echo "$REGISTRY_PASSWORD" | docker login ghcr.io -u "$REGISTRY_USERNAME" --password-stdin

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Test {{ image.name }}
        run: uv run image-manager test {{ image.name }} --snapshot-id "$SNAPSHOT_ID" --pull

{% endfor %}
  # === DEPLOY REPORTS TO GH-PAGES ===
  deploy-reports:
    runs-on: ubuntu-latest
    needs:
{%- for image in images %}
      - test-{{ image.name }}
{%- endfor %}
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync
{%- for image in images %}

      - name: Download {{ image.name }}-manifest artifact
        uses: actions/download-artifact@v4
        with:
          name: {{ image.name }}-manifest
          path: dist/
{%- for platform in platforms %}

      - name: Download {{ image.name }}-{{ platform }} artifact
        uses: actions/download-artifact@v4
        with:
          name: {{ image.name }}-{{ platform }}
          path: dist/
{%- endfor %}
{%- endfor %}

      - name: Generate overview report
        run: uv run image-manager generate

      - name: Prepare gh-pages content
        run: |
          mkdir -p gh-pages-content
          # Copy all HTML reports
          find dist -name "*.html" -exec cp --parents {} gh-pages-content/ \;
          # Copy all SBOM JSON files
          find dist -name "sbom*.json" -exec cp --parents {} gh-pages-content/ \;
          # Move dist contents to root of gh-pages
          mv gh-pages-content/dist/* gh-pages-content/ || true
          rm -rf gh-pages-content/dist

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: {{ "${{ secrets.GITHUB_TOKEN }}" }}
          publish_dir: ./gh-pages-content
          publish_branch: gh-pages
          force_orphan: true
