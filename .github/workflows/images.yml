# Auto-generated by image-manager generate-ci
# Generated: 2026-01-30T16:31:10.877900+00:00
# Custom template for GHCR publishing with gh-pages reports
# Regenerate with: image-manager generate-ci --template .github/ci-templates/ --output .github/workflows/images.yml

name: Build Images

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  SNAPSHOT_ID: ${{ github.event.pull_request.number }}
  REGISTRY_URL: ghcr.io/${{ github.repository }}
  REGISTRY_USERNAME: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  # === GENERATE ===
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Generate Dockerfiles and configs
        run: uv run image-manager generate --snapshot-id "$SNAPSHOT_ID"

      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated
          path: dist/
          retention-days: 7


  # === BASE ===
  # Build amd64
  build-base-amd64:
    runs-on: ubuntu-latest
    needs:
      - generate
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Build base for amd64
        run: uv run image-manager build base --snapshot-id "$SNAPSHOT_ID" --platform amd64

      - name: Generate SBOM for base (amd64)
        run: uv run image-manager sbom base --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: base-amd64-build
          path: |
            dist/base/*/linux-amd64/sbom*.json
            dist/base/*/linux-amd64/sbom-report.html
            dist/base/*/index.html
            dist/base/*/*.html
            dist/base/*/*.json
          retention-days: 7

  # Build arm64
  build-base-arm64:
    runs-on: ubuntu-24.04-arm
    needs:
      - generate
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Build base for arm64
        run: uv run image-manager build base --snapshot-id "$SNAPSHOT_ID" --platform arm64

      - name: Generate SBOM for base (arm64)
        run: uv run image-manager sbom base --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: base-arm64-build
          path: |
            dist/base/*/linux-arm64/sbom*.json
            dist/base/*/linux-arm64/sbom-report.html
            dist/base/*/index.html
            dist/base/*/*.html
            dist/base/*/*.json
          retention-days: 7

  # Create multi-platform manifest
  manifest-base:
    runs-on: ubuntu-latest
    needs:
      - build-base-amd64
      - build-base-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Create multi-platform manifest for base
        run: uv run image-manager manifest base --snapshot-id "$SNAPSHOT_ID"

      - name: Apply aliases for base
        run: uv run image-manager retag base --snapshot-id "$SNAPSHOT_ID"

  test-base:
    runs-on: ubuntu-latest
    needs:
      - manifest-base
    services:
      dind:
        image: docker:dind
        ports:
          - 2375:2375
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: ""
    env:
      DOCKER_HOST: tcp://127.0.0.1:2375
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Wait for Docker
        run: |
          for i in {1..30}; do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              exit 0
            fi
            echo "Waiting for Docker... ($i/30)"
            sleep 1
          done
          echo "Docker failed to start"
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        run: echo "$REGISTRY_PASSWORD" | docker login ghcr.io -u "$REGISTRY_USERNAME" --password-stdin

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Test base
        run: uv run image-manager test base --snapshot-id "$SNAPSHOT_ID" --pull


  # === DOTNET ===
  # Build amd64
  build-dotnet-amd64:
    runs-on: ubuntu-latest
    needs:
      - generate
      - test-base
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Build dotnet for amd64
        run: uv run image-manager build dotnet --snapshot-id "$SNAPSHOT_ID" --platform amd64

      - name: Generate SBOM for dotnet (amd64)
        run: uv run image-manager sbom dotnet --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-amd64-build
          path: |
            dist/dotnet/*/linux-amd64/sbom*.json
            dist/dotnet/*/linux-amd64/sbom-report.html
            dist/dotnet/*/index.html
            dist/dotnet/*/*.html
            dist/dotnet/*/*.json
          retention-days: 7

  # Build arm64
  build-dotnet-arm64:
    runs-on: ubuntu-24.04-arm
    needs:
      - generate
      - test-base
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Build dotnet for arm64
        run: uv run image-manager build dotnet --snapshot-id "$SNAPSHOT_ID" --platform arm64

      - name: Generate SBOM for dotnet (arm64)
        run: uv run image-manager sbom dotnet --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-arm64-build
          path: |
            dist/dotnet/*/linux-arm64/sbom*.json
            dist/dotnet/*/linux-arm64/sbom-report.html
            dist/dotnet/*/index.html
            dist/dotnet/*/*.html
            dist/dotnet/*/*.json
          retention-days: 7

  # Create multi-platform manifest
  manifest-dotnet:
    runs-on: ubuntu-latest
    needs:
      - build-dotnet-amd64
      - build-dotnet-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Create multi-platform manifest for dotnet
        run: uv run image-manager manifest dotnet --snapshot-id "$SNAPSHOT_ID"

      - name: Apply aliases for dotnet
        run: uv run image-manager retag dotnet --snapshot-id "$SNAPSHOT_ID"

  test-dotnet:
    runs-on: ubuntu-latest
    needs:
      - manifest-dotnet
    services:
      dind:
        image: docker:dind
        ports:
          - 2375:2375
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: ""
    env:
      DOCKER_HOST: tcp://127.0.0.1:2375
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Wait for Docker
        run: |
          for i in {1..30}; do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              exit 0
            fi
            echo "Waiting for Docker... ($i/30)"
            sleep 1
          done
          echo "Docker failed to start"
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        run: echo "$REGISTRY_PASSWORD" | docker login ghcr.io -u "$REGISTRY_USERNAME" --password-stdin

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Test dotnet
        run: uv run image-manager test dotnet --snapshot-id "$SNAPSHOT_ID" --pull


  # === PYTHON ===
  # Build amd64
  build-python-amd64:
    runs-on: ubuntu-latest
    needs:
      - generate
      - test-base
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Build python for amd64
        run: uv run image-manager build python --snapshot-id "$SNAPSHOT_ID" --platform amd64

      - name: Generate SBOM for python (amd64)
        run: uv run image-manager sbom python --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-amd64-build
          path: |
            dist/python/*/linux-amd64/sbom*.json
            dist/python/*/linux-amd64/sbom-report.html
            dist/python/*/index.html
            dist/python/*/*.html
            dist/python/*/*.json
          retention-days: 7

  # Build arm64
  build-python-arm64:
    runs-on: ubuntu-24.04-arm
    needs:
      - generate
      - test-base
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Build python for arm64
        run: uv run image-manager build python --snapshot-id "$SNAPSHOT_ID" --platform arm64

      - name: Generate SBOM for python (arm64)
        run: uv run image-manager sbom python --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-arm64-build
          path: |
            dist/python/*/linux-arm64/sbom*.json
            dist/python/*/linux-arm64/sbom-report.html
            dist/python/*/index.html
            dist/python/*/*.html
            dist/python/*/*.json
          retention-days: 7

  # Create multi-platform manifest
  manifest-python:
    runs-on: ubuntu-latest
    needs:
      - build-python-amd64
      - build-python-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Create multi-platform manifest for python
        run: uv run image-manager manifest python --snapshot-id "$SNAPSHOT_ID"

      - name: Apply aliases for python
        run: uv run image-manager retag python --snapshot-id "$SNAPSHOT_ID"

  test-python:
    runs-on: ubuntu-latest
    needs:
      - manifest-python
    services:
      dind:
        image: docker:dind
        ports:
          - 2375:2375
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: ""
    env:
      DOCKER_HOST: tcp://127.0.0.1:2375
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Wait for Docker
        run: |
          for i in {1..30}; do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              exit 0
            fi
            echo "Waiting for Docker... ($i/30)"
            sleep 1
          done
          echo "Docker failed to start"
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        run: echo "$REGISTRY_PASSWORD" | docker login ghcr.io -u "$REGISTRY_USERNAME" --password-stdin

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Test python
        run: uv run image-manager test python --snapshot-id "$SNAPSHOT_ID" --pull


  # === DEPLOY REPORTS TO GH-PAGES ===
  deploy-reports:
    runs-on: ubuntu-latest
    needs:
      - test-base
      - test-dotnet
      - test-python
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Download base-amd64-build artifact
        uses: actions/download-artifact@v4
        with:
          name: base-amd64-build
          path: dist/

      - name: Download base-arm64-build artifact
        uses: actions/download-artifact@v4
        with:
          name: base-arm64-build
          path: dist/

      - name: Download dotnet-amd64-build artifact
        uses: actions/download-artifact@v4
        with:
          name: dotnet-amd64-build
          path: dist/

      - name: Download dotnet-arm64-build artifact
        uses: actions/download-artifact@v4
        with:
          name: dotnet-arm64-build
          path: dist/

      - name: Download python-amd64-build artifact
        uses: actions/download-artifact@v4
        with:
          name: python-amd64-build
          path: dist/

      - name: Download python-arm64-build artifact
        uses: actions/download-artifact@v4
        with:
          name: python-arm64-build
          path: dist/

      - name: Generate overview report
        run: uv run image-manager generate

      - name: Prepare gh-pages content
        run: |
          mkdir -p gh-pages-content
          # Copy all HTML reports
          find dist -name "*.html" -exec cp --parents {} gh-pages-content/ \;
          # Copy all SBOM JSON files
          find dist -name "sbom*.json" -exec cp --parents {} gh-pages-content/ \;
          # Move dist contents to root of gh-pages
          mv gh-pages-content/dist/* gh-pages-content/ || true
          rm -rf gh-pages-content/dist

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-content
          publish_branch: gh-pages
          force_orphan: true
