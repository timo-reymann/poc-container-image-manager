# Auto-generated by image-manager generate-ci
# Generated: 2026-01-30T10:48:39.611448+00:00
# Custom template for GHCR publishing with gh-pages reports
# Regenerate with: image-manager generate-ci --template .github/ci-templates/ --output .github/workflows/images.yml

name: Build Images

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  SNAPSHOT_ID: ${{ github.event.pull_request.number }}
  REGISTRY_URL: ghcr.io/${{ github.repository }}
  REGISTRY_USERNAME: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  # === GENERATE ===
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Generate Dockerfiles and configs
        run: uv run image-manager generate --snapshot-id "$SNAPSHOT_ID"

      - name: Upload generated artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated
          path: dist/
          retention-days: 7


  # === BASE ===
  build-base:
    runs-on: ubuntu-latest
    needs:
      - generate
    env:
      BUILDKIT_HOST: tcp://127.0.0.1:8372
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Start buildkitd
        run: |
          docker run -d --name buildkitd --privileged \
            -p 127.0.0.1:8372:8372 \
            moby/buildkit:latest \
            --addr tcp://0.0.0.0:8372
          # Wait for buildkitd to be ready
          for i in {1..30}; do
            if nc -z 127.0.0.1 8372 2>/dev/null; then
              echo "buildkitd is ready"
              exit 0
            fi
            echo "Waiting for buildkitd... ($i/30)"
            sleep 1
          done
          echo "buildkitd logs:"
          docker logs buildkitd
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Build base (multi-platform with QEMU)
        run: uv run image-manager build base --snapshot-id "$SNAPSHOT_ID"

      - name: Generate SBOM for base
        run: uv run image-manager sbom base --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: base-build
          path: |
            dist/base/*/linux-*/sbom*.json
            dist/base/*/linux-*/sbom-report.html
            dist/base/*/index.html
            dist/base/*/*.html
            dist/base/*/*.json
          retention-days: 7

  test-base:
    runs-on: ubuntu-latest
    needs:
      - build-base
    services:
      dind:
        image: docker:dind
        ports:
          - 2375:2375
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: ""
    env:
      DOCKER_HOST: tcp://127.0.0.1:2375
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Wait for Docker
        run: |
          for i in {1..30}; do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              exit 0
            fi
            echo "Waiting for Docker... ($i/30)"
            sleep 1
          done
          echo "Docker failed to start"
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        run: echo "$REGISTRY_PASSWORD" | docker login ghcr.io -u "$REGISTRY_USERNAME" --password-stdin

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Test base
        run: uv run image-manager test base --snapshot-id "$SNAPSHOT_ID" --pull


  # === DOTNET ===
  build-dotnet:
    runs-on: ubuntu-latest
    needs:
      - generate
      - build-base
    env:
      BUILDKIT_HOST: tcp://127.0.0.1:8372
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Start buildkitd
        run: |
          docker run -d --name buildkitd --privileged \
            -p 127.0.0.1:8372:8372 \
            moby/buildkit:latest \
            --addr tcp://0.0.0.0:8372
          # Wait for buildkitd to be ready
          for i in {1..30}; do
            if nc -z 127.0.0.1 8372 2>/dev/null; then
              echo "buildkitd is ready"
              exit 0
            fi
            echo "Waiting for buildkitd... ($i/30)"
            sleep 1
          done
          echo "buildkitd logs:"
          docker logs buildkitd
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Build dotnet (multi-platform with QEMU)
        run: uv run image-manager build dotnet --snapshot-id "$SNAPSHOT_ID"

      - name: Generate SBOM for dotnet
        run: uv run image-manager sbom dotnet --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-build
          path: |
            dist/dotnet/*/linux-*/sbom*.json
            dist/dotnet/*/linux-*/sbom-report.html
            dist/dotnet/*/index.html
            dist/dotnet/*/*.html
            dist/dotnet/*/*.json
          retention-days: 7

  test-dotnet:
    runs-on: ubuntu-latest
    needs:
      - build-dotnet
    services:
      dind:
        image: docker:dind
        ports:
          - 2375:2375
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: ""
    env:
      DOCKER_HOST: tcp://127.0.0.1:2375
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Wait for Docker
        run: |
          for i in {1..30}; do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              exit 0
            fi
            echo "Waiting for Docker... ($i/30)"
            sleep 1
          done
          echo "Docker failed to start"
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        run: echo "$REGISTRY_PASSWORD" | docker login ghcr.io -u "$REGISTRY_USERNAME" --password-stdin

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Test dotnet
        run: uv run image-manager test dotnet --snapshot-id "$SNAPSHOT_ID" --pull


  # === PYTHON ===
  build-python:
    runs-on: ubuntu-latest
    needs:
      - generate
      - build-base
    env:
      BUILDKIT_HOST: tcp://127.0.0.1:8372
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Start buildkitd
        run: |
          docker run -d --name buildkitd --privileged \
            -p 127.0.0.1:8372:8372 \
            moby/buildkit:latest \
            --addr tcp://0.0.0.0:8372
          # Wait for buildkitd to be ready
          for i in {1..30}; do
            if nc -z 127.0.0.1 8372 2>/dev/null; then
              echo "buildkitd is ready"
              exit 0
            fi
            echo "Waiting for buildkitd... ($i/30)"
            sleep 1
          done
          echo "buildkitd logs:"
          docker logs buildkitd
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Build python (multi-platform with QEMU)
        run: uv run image-manager build python --snapshot-id "$SNAPSHOT_ID"

      - name: Generate SBOM for python
        run: uv run image-manager sbom python --snapshot-id "$SNAPSHOT_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-build
          path: |
            dist/python/*/linux-*/sbom*.json
            dist/python/*/linux-*/sbom-report.html
            dist/python/*/index.html
            dist/python/*/*.html
            dist/python/*/*.json
          retention-days: 7

  test-python:
    runs-on: ubuntu-latest
    needs:
      - build-python
    services:
      dind:
        image: docker:dind
        ports:
          - 2375:2375
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: ""
    env:
      DOCKER_HOST: tcp://127.0.0.1:2375
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Wait for Docker
        run: |
          for i in {1..30}; do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              exit 0
            fi
            echo "Waiting for Docker... ($i/30)"
            sleep 1
          done
          echo "Docker failed to start"
          exit 1

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Log in to GHCR
        run: echo "$REGISTRY_PASSWORD" | docker login ghcr.io -u "$REGISTRY_USERNAME" --password-stdin

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Test python
        run: uv run image-manager test python --snapshot-id "$SNAPSHOT_ID" --pull


  # === DEPLOY REPORTS TO GH-PAGES ===
  deploy-reports:
    runs-on: ubuntu-latest
    needs:
      - test-base
      - test-dotnet
      - test-python
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated
          path: dist/

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Download base-build artifact
        uses: actions/download-artifact@v4
        with:
          name: base-build
          path: dist/

      - name: Download dotnet-build artifact
        uses: actions/download-artifact@v4
        with:
          name: dotnet-build
          path: dist/

      - name: Download python-build artifact
        uses: actions/download-artifact@v4
        with:
          name: python-build
          path: dist/

      - name: Generate overview report
        run: uv run image-manager generate

      - name: Prepare gh-pages content
        run: |
          mkdir -p gh-pages-content
          # Copy all HTML reports
          find dist -name "*.html" -exec cp --parents {} gh-pages-content/ \;
          # Copy all SBOM JSON files
          find dist -name "sbom*.json" -exec cp --parents {} gh-pages-content/ \;
          # Move dist contents to root of gh-pages
          mv gh-pages-content/dist/* gh-pages-content/ || true
          rm -rf gh-pages-content/dist

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-content
          publish_branch: gh-pages
          force_orphan: true
